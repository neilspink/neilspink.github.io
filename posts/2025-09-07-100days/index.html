<!doctype html><html lang=en-us><head><meta charset=utf-8><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=robots content="index, follow"><meta name=author content><meta name=description content="Coding blog"><link rel=author type=text/plain href=/humans.txt><link rel=manifest href=/site.webmanifest><link rel=icon type=image/png sizes=96x96 href=/favicon-96x96.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><meta name=apple-mobile-web-app-title content="Hermit - V2"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><link rel=mask-icon href=/safari-pinned-tab.svg color=#494f5c><meta itemprop=name content="100days.ink — A Commitment Engine"><meta itemprop=description content="I’ve been building 100days.ink, a small app with a big purpose:
help people commit to something for 100 days and actually follow through.
The rules are simple:
Write down your 100-day commitment. Pick a start or end date. Decide if it’s private, public, or shared with the community. Support the idea with a tip. That’s it. No feeds. No distractions. Just you versus the next 100 days.
The idea comes from watching the video I Worked Out Like David Goggins for 100 Days."><meta itemprop=datePublished content="2025-09-07T00:00:00+00:00"><meta itemprop=dateModified content="2025-09-07T00:00:00+00:00"><meta itemprop=wordCount content="1076"><meta itemprop=keywords content="100days,commitment,focus,execution,"><meta property="og:title" content="100days.ink — A Commitment Engine"><meta property="og:description" content="I’ve been building 100days.ink, a small app with a big purpose:
help people commit to something for 100 days and actually follow through.
The rules are simple:
Write down your 100-day commitment. Pick a start or end date. Decide if it’s private, public, or shared with the community. Support the idea with a tip. That’s it. No feeds. No distractions. Just you versus the next 100 days.
The idea comes from watching the video I Worked Out Like David Goggins for 100 Days."><meta property="og:type" content="article"><meta property="og:url" content="https://neilspink.ch/posts/2025-09-07-100days/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-09-07T00:00:00+00:00"><meta property="article:modified_time" content="2025-09-07T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="100days.ink — A Commitment Engine"><meta name=twitter:description content="I’ve been building 100days.ink, a small app with a big purpose:
help people commit to something for 100 days and actually follow through.
The rules are simple:
Write down your 100-day commitment. Pick a start or end date. Decide if it’s private, public, or shared with the community. Support the idea with a tip. That’s it. No feeds. No distractions. Just you versus the next 100 days.
The idea comes from watching the video I Worked Out Like David Goggins for 100 Days."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"100days.ink — A Commitment Engine","name":"100days.ink — A Commitment Engine","description":"I’ve been building 100days.ink, a small app with a big purpose:\nhelp people commit to something for 100 days and actually follow through.\nThe rules are simple:\nWrite down your 100-day commitment. Pick a start or end date. Decide if it’s private, public, or shared with the community. Support the idea with a tip. That’s it. No feeds. No distractions. Just you versus the next 100 days.\nThe idea comes from watching the video I Worked Out Like David Goggins for 100 Days.","keywords":["100days","commitment","focus","execution"],"articleBody":"I’ve been building 100days.ink, a small app with a big purpose:\nhelp people commit to something for 100 days and actually follow through.\nThe rules are simple:\nWrite down your 100-day commitment. Pick a start or end date. Decide if it’s private, public, or shared with the community. Support the idea with a tip. That’s it. No feeds. No distractions. Just you versus the next 100 days.\nThe idea comes from watching the video I Worked Out Like David Goggins for 100 Days. Both entertaining and showing what happens when you truely commit to goal. Momentum compounds when you consistenly deliver. It lit the spark for my own 100-day project but instead of doing fitness, I wanted to program again and why not build a commitment engine that backs you on such a venture. Something that turns promises into action and accountability into a game you can actually win.\nI wanted massive scaling capacity and chose Firebase. Their NoSQL backend provides granual access control and easy auth. I eventually extended with Firebase Storage for images, because words aren’t always enough. On top of that I run a free cron-job.org task to push daily reminders with short coaching notes to your mailbox and a weekly digest newsletter. To make it dynamic, the AI coach changes tone: if you skip check-ins, the temperature parameter gets dialed up, making the responses a little sharper, a little more urgent. The app is minimal on purpose, a fun MVP.\nI didn’t expect login and then email to be the hardest parts of the 100days.ink project. If registration emails land in the spam folder, your app is dead before it starts.\nEven with a notice to look in the spam folder, few persons actually completed the registration.\nYou get what you pay for. And this one-size-fits-all backend forced me to jam Firebase’s user model into mine. Registration emails come from their *.firebaseapp.com domain. That’s a red flag for spam filters when your sending domain is 100days.ink.\nThe Firestore database I found very practical.\nI liked building in Next.js with TypeScript. The API routes, file-based routing, server + client all in one was a good first experience. I’ve worked with Angular before and completed a project in Ember.js, but moving into the React ecosystem was a great.\nMaking it mobile friendly was important to me. You get a link every day to reflect on your 100 day mission.\nEvery day, the system runs a user’s most recent reflections through OpenAI, combining their goal, coaching style, and behavioral patterns to generate personalized advice and an email subject line in their coach’s voice. It tags each reflection with a “vibe” like grit or desperation, adjusts the tone dynamically based on past engagement, trying to keep users moving forward—even if it has to jolt them.\nI was worried OpenAI usage might blow up my budget, so I limited output length and kept prompts tight. But it turns out, even with daily usage across multiple users, the cost has been laughably low.\nI pushed 100days on X and ran a small ad campaign, but it didn’t gain much traction. In September I stared building the social features, but ultimately decided to wrap the project.\nThere were several cool parts of the project:\nMotivational styles of the AI\nData-driven coach definitions: data/architypes.json Behavioral constraints: data/guardrails.json Used by the coaching pipeline: app/api/coaching/route.ts AI coaching pipeline\napp/api/coaching/route.ts (OpenAI Responses API + Firestore reads/writes + cron header guard) Job runners: scripts/runCoaching.js, scripts/executeCoaching.js Single-use / time-limited “mission day” links (JWT)\nLink generator: lib/generateLink.ts API wrapper: app/api/generate-link/route.ts Consumed by daily pushes: app/api/push-daily/route.ts The mission day page: app/mission/day/[id]/page.tsx Reflection system with image upload\nReflection API: app/api/reflect/route.ts (multipart parsing, uploads, conditional reuse of existing image) UI list: app/components/ReflectionList.tsx Active user + signed image URLs: lib/mission.ts Automated email engine using Markdown templates\nTemplate loader + subject parsing: lib/email-template.ts Weekly templates: lib/emails/ Sending flows: app/api/push-daily/route.ts and app/api/commitment/route.ts Daily workflow orchestrator (“push-daily”)\nOrchestrator: app/api/push-daily/route.ts Monetization path: Stripe “tip” checkout\nTip endpoint: app/api/tip/route.ts Support page: app/support/page.tsx Image uploads feature\nI assumed image uploads would be a quick win: accept a photo, store it, show it back in the reflection timeline. On the UX side, I didn’t want “upload failed” to be a dead end. If the upload fails due to size, the user gets a direct link to compress the image and try again (e.g. Squoosh: https://squoosh.app/).\nThe core trick in providing this feature was adapting NextRequest for multipart parsing + safe failure UX\nimport { NextRequest, NextResponse } from \"next/server\"; import multer from \"multer\"; import { Readable } from \"stream\"; const MAX_BYTES = 200 * 1024; // 200 KB const COMPRESS_LINK = \"https://squoosh.app/\"; // Multer in-memory upload with hard limits + mime filtering const upload = multer({ storage: multer.memoryStorage(), limits: { fileSize: MAX_BYTES }, fileFilter: (_req, file, cb) =\u003e { if (!file.mimetype.startsWith(\"image/\")) { return cb(new Error(\"Only image uploads are allowed.\")); } cb(null, true); }, }); // Promise wrapper for classic Node middleware function runMiddleware(req: any, res: any, fn: any) { return new Promise\u003cvoid\u003e((resolve, reject) =\u003e { fn(req, res, (result: any) =\u003e (result instanceof Error ? reject(result) : resolve())); }); } // Adapt NextRequest -\u003e Node Readable so multer can parse multipart/form-data function toNodeReadable(req: NextRequest) { const nodeReq: any = new Readable({ read() {} }); nodeReq.headers = Object.fromEntries(req.headers.entries()); nodeReq.method = req.method; nodeReq.url = req.url; return nodeReq; } function isMulterFileTooLarge(err: unknown) { // Multer uses code === \"LIMIT_FILE_SIZE\" for size issues return typeof err === \"object\" \u0026\u0026 err !== null \u0026\u0026 (err as any).code === \"LIMIT_FILE_SIZE\"; } export async function POST(req: NextRequest) { const nodeReq = toNodeReadable(req); const nodeRes = { end() {}, setHeader() {}, getHeader() {} }; // Push the full body into the Readable stream for multer to consume const body = Buffer.from(await req.arrayBuffer()); nodeReq.push(body); nodeReq.push(null); try { await runMiddleware(nodeReq, nodeRes, upload.single(\"image\")); } catch (err) { // Defensive programming: clear, actionable error for the user if (isMulterFileTooLarge(err)) { return NextResponse.json( { error: `Image is too large (max ${MAX_BYTES / 1024}KB).`, help: \"Compress your image and try again:\", link: COMPRESS_LINK, }, { status: 413 } ); } return NextResponse.json( { error: \"Upload failed. Please try a different image.\" }, { status: 400 } ); } const fields = nodeReq.body ?? {}; const file = nodeReq.file; // { originalname, mimetype, buffer, size, ... } if (!fields.reflection || !fields.answer || !fields.day) { return NextResponse.json({ error: \"Missing required fields.\" }, { status: 400 }); } // ...continue with auth checks, validation, storage upload, and DB write... return NextResponse.json({ ok: true }); } ","wordCount":"1076","inLanguage":"en","datePublished":"2025-09-07T00:00:00Z","dateModified":"2025-09-07T00:00:00Z","author":{"@type":"Person","name":null},"mainEntityOfPage":{"@type":"WebPage","@id":"https://neilspink.ch/posts/2025-09-07-100days/"},"publisher":{"@type":"Organization","name":"Neil Spink","description":"Coding blog","logo":{"@type":"ImageObject","url":"https://neilspink.ch/favicon.ico"}}}</script><title>100days.ink — A Commitment Engine</title><link rel="stylesheet dns-prefetch preconnect preload prefetch" as=style media=screen href=https://neilspink.ch/css/style.min.1e4285ed8618af3d2ffe8dfd5bf3fca90477b7b683548f5f40f54b3611a153df.css integrity="sha256-HkKF7YYYrz0v/o39W/P8qQR3t7aDVI9fQPVLNhGhU98=" crossorigin=anonymous></head><body id=page><header id=site-header><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://neilspink.ch/>Neil Spink</a></div><nav class="site-nav hide-in-mobile"><a href=https://neilspink.ch/posts/>Posts</a><a href=https://www.linkedin.com/in/neilspink/>About</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-links hide-in-mobile"><a href=https://github.com/neilspink target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://neilspink.ch/posts/>Posts</a></li><li><a href=https://www.linkedin.com/in/neilspink/>About</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-date><span>Sep 7, 2025</span></div><h1>100days.ink — A Commitment Engine</h1></header><div class=post-description></p></div><hr class=post-end><div class=content><p>I’ve been building <a href=https://100days.ink>100days.ink</a>, a small app with a big purpose:<br>help people commit to something for 100 days and actually follow through.</p><p>The rules are simple:</p><ul><li>Write down your 100-day commitment.</li><li>Pick a start or end date.</li><li>Decide if it’s private, public, or shared with the community.</li><li>Support the idea with a tip.</li></ul><p>That’s it. No feeds. No distractions. Just you versus the next 100 days.</p><p><img src=100daysink.png alt="100Days.ink landing page"></p><p>The idea comes from watching the video <a href="https://youtu.be/vWU5O7cK7aI?si=Qvuerw0Zx3Y68PMf">I Worked Out Like David Goggins for 100 Days</a>. Both entertaining and showing what happens when you truely commit to goal. Momentum compounds when you consistenly deliver. It lit the spark for my own 100-day project but instead of doing fitness, I wanted to program again and why not build a commitment engine that backs you on such a venture. Something that turns promises into action and accountability into a game you can actually win.</p><p>I wanted massive scaling capacity and chose Firebase. Their NoSQL backend provides granual access control and easy auth. I eventually extended with Firebase Storage for images, because words aren’t always enough. On top of that I run a free cron-job.org task to push daily reminders with short coaching notes to your mailbox and a weekly digest newsletter. To make it dynamic, the AI coach changes tone: if you skip check-ins, the temperature parameter gets dialed up, making the responses a little sharper, a little more urgent. The app is minimal on purpose, a fun MVP.</p><p>I didn’t expect login and then email to be the hardest parts of the 100days.ink project. If registration emails land in the spam folder, your app is dead before it starts.</p><p><img src=commitment-saved-confirmation.png alt="100Days.ink regristration page with spam folder notice"></p><p>Even with a notice to look in the spam folder, few persons actually completed the registration.</p><p><img src=spam-mail2.png alt="Spam mail example"></p><p>You get what you pay for. And this one-size-fits-all backend forced me to jam Firebase’s user model into mine. Registration emails come from their *.firebaseapp.com domain. That’s a red flag for spam filters when your sending domain is 100days.ink.</p><p><img src=firebase-users.png alt="Firebase authenication console"></p><p>The Firestore database I found very practical.</p><p><img src=firebase-database-entry.png alt="Firestore database"></p><p>I liked building in Next.js with TypeScript. The API routes, file-based routing, server + client all in one was a good first experience. I’ve worked with Angular before and completed a project in Ember.js, but moving into the React ecosystem was a great.</p><p>Making it mobile friendly was important to me. You get a link every day to reflect on your 100 day mission.</p><img src=UI-day1.jpg alt="Day 1 reflection" width=375><p>Every day, the system runs a user’s most recent reflections through OpenAI, combining their goal, coaching style, and behavioral patterns to generate personalized advice and an email subject line in their coach’s voice. It tags each reflection with a “vibe” like grit or desperation, adjusts the tone dynamically based on past engagement, trying to keep users moving forward—even if it has to jolt them.</p><p><img src=emails.png alt="Example emails"></p><p>I was worried OpenAI usage might blow up my budget, so I limited output length and kept prompts tight. But it turns out, even with daily usage across multiple users, the cost has been laughably low.</p><p><img src=openai.png alt="OpenAI costs"></p><p>I pushed 100days on X and ran a small ad campaign, but it didn’t gain much traction. In September I stared building the social features, but ultimately decided to wrap the project.</p><p><img src=github.png alt="Github commits"></p><p>There were several cool parts of the project:</p><p><strong>Motivational styles of the AI</strong></p><ul><li>Data-driven coach definitions: <a href=https://github.com/neilspink/100days-site/blob/main/data/architypes.json>data/architypes.json</a></li><li>Behavioral constraints: <a href=https://github.com/neilspink/100days-site/blob/main/data/guardrails.json>data/guardrails.json</a></li><li>Used by the coaching pipeline: <a href=https://github.com/neilspink/100days-site/blob/main/app/api/coaching/route.ts>app/api/coaching/route.ts</a></li></ul><p><strong>AI coaching pipeline</strong></p><ul><li><a href=https://github.com/neilspink/100days-site/blob/main/app/api/coaching/route.ts>app/api/coaching/route.ts</a> (OpenAI Responses API + Firestore reads/writes + cron header guard)</li><li>Job runners: <a href=https://github.com/neilspink/100days-site/blob/main/scripts/runCoaching.js>scripts/runCoaching.js</a>, <a href=https://github.com/neilspink/100days-site/blob/main/scripts/executeCoaching.js>scripts/executeCoaching.js</a></li></ul><p><strong>Single-use / time-limited “mission day” links (JWT)</strong></p><ul><li>Link generator: <a href=https://github.com/neilspink/100days-site/blob/main/lib/generateLink.ts>lib/generateLink.ts</a></li><li>API wrapper: <a href=https://github.com/neilspink/100days-site/blob/main/app/api/generate-link/route.ts>app/api/generate-link/route.ts</a></li><li>Consumed by daily pushes: <a href=https://github.com/neilspink/100days-site/blob/main/app/api/push-daily/route.ts>app/api/push-daily/route.ts</a></li><li>The mission day page: <a href=https://github.com/neilspink/100days-site/blob/main/app/mission/day/%5Bid%5D/page.tsx>app/mission/day/[id]/page.tsx</a></li></ul><p><strong>Reflection system with image upload</strong></p><ul><li>Reflection API: <a href=https://github.com/neilspink/100days-site/blob/main/app/api/reflect/route.ts>app/api/reflect/route.ts</a> (multipart parsing, uploads, conditional reuse of existing image)</li><li>UI list: <a href=https://github.com/neilspink/100days-site/blob/main/app/components/ReflectionList.tsx>app/components/ReflectionList.tsx</a></li><li>Active user + signed image URLs: <a href=https://github.com/neilspink/100days-site/blob/main/lib/mission.ts>lib/mission.ts</a></li></ul><p><strong>Automated email engine using Markdown templates</strong></p><ul><li>Template loader + subject parsing: <a href=https://github.com/neilspink/100days-site/blob/main/lib/email-template.ts>lib/email-template.ts</a></li><li>Weekly templates: <a href=https://github.com/neilspink/100days-site/tree/main/lib/emails>lib/emails/</a></li><li>Sending flows: <a href=https://github.com/neilspink/100days-site/blob/main/app/api/push-daily/route.ts>app/api/push-daily/route.ts</a> and <a href=https://github.com/neilspink/100days-site/blob/main/app/api/commitment/route.ts>app/api/commitment/route.ts</a></li></ul><p><strong>Daily workflow orchestrator (“push-daily”)</strong></p><ul><li>Orchestrator: <a href=https://github.com/neilspink/100days-site/blob/main/app/api/push-daily/route.ts>app/api/push-daily/route.ts</a></li></ul><p><strong>Monetization path: Stripe “tip” checkout</strong></p><ul><li>Tip endpoint: <a href=https://github.com/neilspink/100days-site/blob/main/app/api/tip/route.ts>app/api/tip/route.ts</a></li><li>Support page: <a href=https://github.com/neilspink/100days-site/blob/main/app/support/page.tsx>app/support/page.tsx</a></li></ul><p><img src=support.png alt="Support page"></p><p><strong>Image uploads feature</strong></p><p>I assumed image uploads would be a quick win: accept a photo, store it, show it back in the reflection timeline. On the UX side, I didn’t want “upload failed” to be a dead end. If the upload fails due to size, the user gets a direct link to compress the image and try again (e.g. Squoosh: <a href=https://squoosh.app/)>https://squoosh.app/)</a>.</p><p>The core trick in providing this feature was adapting <code>NextRequest</code> for multipart parsing + safe failure UX</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>NextRequest</span>, <span style=color:#a6e22e>NextResponse</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;next/server&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>multer</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;multer&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Readable</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;stream&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>MAX_BYTES</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>200</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1024</span>; <span style=color:#75715e>// 200 KB
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>COMPRESS_LINK</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://squoosh.app/&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Multer in-memory upload with hard limits + mime filtering
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>upload</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>multer</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>storage</span>: <span style=color:#66d9ef>multer.memoryStorage</span>(),
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>limits</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>fileSize</span>: <span style=color:#66d9ef>MAX_BYTES</span> },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>fileFilter</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>_req</span>, <span style=color:#a6e22e>file</span>, <span style=color:#a6e22e>cb</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>mimetype</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#e6db74>&#34;image/&#34;</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cb</span>(<span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#34;Only image uploads are allowed.&#34;</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cb</span>(<span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Promise wrapper for classic Node middleware
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>runMiddleware</span>(<span style=color:#a6e22e>req</span>: <span style=color:#66d9ef>any</span>, <span style=color:#a6e22e>res</span>: <span style=color:#66d9ef>any</span>, <span style=color:#a6e22e>fn</span>: <span style=color:#66d9ef>any</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt;((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fn</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, (<span style=color:#a6e22e>result</span>: <span style=color:#66d9ef>any</span>) <span style=color:#f92672>=&gt;</span> (<span style=color:#a6e22e>result</span> <span style=color:#66d9ef>instanceof</span> Error <span style=color:#f92672>?</span> <span style=color:#a6e22e>reject</span>(<span style=color:#a6e22e>result</span>) <span style=color:#f92672>:</span> <span style=color:#a6e22e>resolve</span>()));
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Adapt NextRequest -&gt; Node Readable so multer can parse multipart/form-data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>toNodeReadable</span>(<span style=color:#a6e22e>req</span>: <span style=color:#66d9ef>NextRequest</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>nodeReq</span>: <span style=color:#66d9ef>any</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Readable</span>({ <span style=color:#a6e22e>read() {</span>} });
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>nodeReq</span>.<span style=color:#a6e22e>headers</span> <span style=color:#f92672>=</span> Object.<span style=color:#a6e22e>fromEntries</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>headers</span>.<span style=color:#a6e22e>entries</span>());
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>nodeReq</span>.<span style=color:#a6e22e>method</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>method</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>nodeReq</span>.<span style=color:#a6e22e>url</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>url</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>nodeReq</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>isMulterFileTooLarge</span>(<span style=color:#a6e22e>err</span>: <span style=color:#66d9ef>unknown</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Multer uses code === &#34;LIMIT_FILE_SIZE&#34; for size issues
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;object&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> (<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>any</span>).<span style=color:#a6e22e>code</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;LIMIT_FILE_SIZE&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>POST</span>(<span style=color:#a6e22e>req</span>: <span style=color:#66d9ef>NextRequest</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>nodeReq</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>toNodeReadable</span>(<span style=color:#a6e22e>req</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>nodeRes</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>end() {</span>}, <span style=color:#a6e22e>setHeader() {</span>}, <span style=color:#a6e22e>getHeader() {</span>} };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Push the full body into the Readable stream for multer to consume
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>body</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Buffer</span>.<span style=color:#66d9ef>from</span>(<span style=color:#66d9ef>await</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>arrayBuffer</span>());
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>nodeReq</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>body</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>nodeReq</span>.<span style=color:#a6e22e>push</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>runMiddleware</span>(<span style=color:#a6e22e>nodeReq</span>, <span style=color:#a6e22e>nodeRes</span>, <span style=color:#a6e22e>upload</span>.<span style=color:#a6e22e>single</span>(<span style=color:#e6db74>&#34;image&#34;</span>));
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Defensive programming: clear, actionable error for the user
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isMulterFileTooLarge</span>(<span style=color:#a6e22e>err</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>NextResponse</span>.<span style=color:#a6e22e>json</span>(
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Image is too large (max </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>MAX_BYTES</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>1024</span><span style=color:#e6db74>}</span><span style=color:#e6db74>KB).`</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>help</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Compress your image and try again:&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>link</span>: <span style=color:#66d9ef>COMPRESS_LINK</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        { <span style=color:#a6e22e>status</span>: <span style=color:#66d9ef>413</span> }
</span></span><span style=display:flex><span>      );
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>NextResponse</span>.<span style=color:#a6e22e>json</span>(
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Upload failed. Please try a different image.&#34;</span> },
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>status</span>: <span style=color:#66d9ef>400</span> }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fields</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>nodeReq</span>.<span style=color:#a6e22e>body</span> <span style=color:#f92672>??</span> {};
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>file</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>nodeReq</span>.<span style=color:#a6e22e>file</span>; <span style=color:#75715e>// { originalname, mimetype, buffer, size, ... }
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>fields</span>.<span style=color:#a6e22e>reflection</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>fields</span>.<span style=color:#a6e22e>answer</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>fields</span>.<span style=color:#a6e22e>day</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>NextResponse</span>.<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Missing required fields.&#34;</span> }, { <span style=color:#a6e22e>status</span>: <span style=color:#66d9ef>400</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...continue with auth checks, validation, storage upload, and DB write...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>NextResponse</span>.<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>ok</span>: <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div></article><div class="post-nav thin"><a class=prev-post href=https://neilspink.ch/posts/2020-11-27-aheadfork/><span class=post-nav-label>Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>AheadFork: Exploring Forks Ahead of Upstream (Python)</span></a></div><div id=comments class=thin></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2025 <a href=https://neilspink.ch/>Neil Spink</a>
&#183; Personal Blog
&#183; Made with <a href=https://gohugo.io/ target=_blank rel=noopener title="The world's fastest framework for building websites">Hugo</a> & <a href=https://github.com/1bl4z3r/hermit-V2 target=_blank rel=noopener title="A fast, minimalist Hugo theme">Hermit-V2</a></p></footer><script async src=https://neilspink.ch/js/bundle.min.a2910447d5c22e84c4b04382d8c10c056b2b9d3e15c64d1fa04882359d61afd3.js integrity="sha256-opEER9XCLoTEsEOC2MEMBWsrnT4Vxk0foEiCNZ1hr9M=" crossorigin=anonymous></script></body></html>